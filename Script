local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")

local healthText = {}
local nameText = {}

function updateHealth(player)
	if not healthTextEnabled then return end
	if not player.Character or not player.Character:FindFirstChild("Humanoid") or not player.Character:FindFirstChild("Head") then
		if healthText[player] then
			healthText[player]:Remove()
			healthText[player] = nil
		end
		return
	end

	local head = player.Character.Head
	local humanoid = player.Character.Humanoid
	local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 3.3, 0)) -- moved up here

	if not healthText[player] then
		local bar = Drawing.new("Line")
		bar.Thickness = 2
		bar.Color = Color3.fromRGB(0, 255, 0)
		bar.Visible = true
		healthText[player] = bar
	end

	local bar = healthText[player]
	if onScreen and humanoid.Health > 0 then
		local healthPercent = humanoid.Health / humanoid.MaxHealth
		bar.From = Vector2.new(screenPos.X - 25, screenPos.Y)
		bar.To = Vector2.new(screenPos.X - 25 + (50 * healthPercent), screenPos.Y)
		bar.Visible = true
	else
		bar.Visible = false
	end
end

function updateName(player)
	if not nameTextEnabled then return end
	if not player.Character or not player.Character:FindFirstChild("Head") then
		if nameText[player] then
			nameText[player]:Remove()
			nameText[player] = nil
		end
		return
	end

	local head = player.Character.Head
	local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 3.5, 0))

	if not nameText[player] then
		local label = Drawing.new("Text")
		label.Size = 14
		label.Outline = true
		label.Center = true
		label.Color = Color3.fromRGB(255, 255, 255)
		label.Visible = true
		nameText[player] = label
	end

	local label = nameText[player]
	if onScreen then
		label.Position = Vector2.new(screenPos.X, screenPos.Y)
		label.Text = player.Name
		label.Visible = true
	else
		label.Visible = false
	end
end

RunService.RenderStepped:Connect(function()
	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			updateHealth(player)
			updateName(player)
		end
	end
end)
